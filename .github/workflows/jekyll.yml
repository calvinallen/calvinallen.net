name: Jekyll Build and Deployment

on:
  schedule:
    # 11am UTC = 7am EST (for now...stupid DST
    - cron: 0 11 * * *
  push:
    branches: 
      - master

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Ruby
      uses: actions/setup-ruby@v1.0.0
      with:
        version: 2.x
      
    - name: Build Jekyll
      run: |
        gem install bundler
        bundle install
        bundle exec jekyll build    

    - name: Upload to Azure
      uses: bacongobbler/azure-blob-storage-upload@v1.0.0
      with:
        source_dir: _site
        container_name: $web
        connection_string: ${{secrets.AZURE_BLOB_CONNECTIONSTRING}}

    - name: Azure Login
      uses: Azure/login@v1
      with:
        # Paste output of `az ad sp create-for-rbac` as value of secret variable: AZURE_CREDENTIALS
        creds: ${{secrets.AZURE_CREDENTIALS}}
            
    - name: Azure CLI Action
      uses: Azure/cli@v1.0.0
      with:
        # Specify the script here
        inlineScript: |
          az extension add --name front-door
          az network front-door purge-endpoint --resource-group calvinallen.net --name calvinallen --content-paths "/"
